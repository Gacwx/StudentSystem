@using MyApp.Mvc.Models
@model IEnumerable<StudentVm>
@{
    var deps = ViewBag.Departments as List<DepartmentVm> ?? new();
}

<h2>Students</h2>

<label>Department:</label>
<select id="departmentSelect" class="form-select">
    <option value="">-- All Departments --</option>
    @foreach (var d in deps)
    {
        <option value="@d.Id">@d.Name</option>
    }
</select>

<table class="table" id="studentsTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Gender</th>
            <th>Department</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var s in Model)
        {
            <tr>
                <td>@s.Name</td>
                <td>@s.Email</td>
                <td>@s.Gender</td>
                <td>@s.Department?.Name</td>
            </tr>
        }
    </tbody>
</table>

<h3>Create student</h3>
<form id="createForm">
    <input id="name" placeholder="Name" required />
    <input id="email" placeholder="Email" type="email" required />
    <select id="gender">
        <option>Male</option>
        <option>Female</option>
    </select>
    <select id="departmentId">
        @foreach (var d in deps)
        {
            <option value="@d.Id">@d.Name</option>
        }
    </select>
    <button type="submit">Create</button>
</form>

<script>
    const tableBody = document.querySelector('#studentsTable tbody');
    const deptSelect = document.getElementById('departmentSelect');

    // Filter AJAX
    deptSelect.addEventListener('change', function() {
        const deptId = this.value;
        fetch(`/Home/GetStudentsByDepartment?departmentId=${deptId}`)
            .then(res => res.json())
            .then(data => {
                tableBody.innerHTML = '';
                data.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${s.name}</td>
                        <td>${s.email}</td>
                        <td>${s.gender}</td>
                        <td>${s.departmentName || ''}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            })
            .catch(err => console.error(err));
    });

    // Create student AJAX
    const createForm = document.getElementById('createForm');
    createForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const student = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            gender: document.getElementById('gender').value,
            departmentId: parseInt(document.getElementById('departmentId').value)
        };

        fetch('/Home/CreateStudent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(student)
        })
        .then(res => res.json())
        .then(s => {
            if (!deptSelect.value || deptSelect.value === s.departmentId.toString()) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.name}</td>
                    <td>${s.email}</td>
                    <td>${s.gender}</td>
                    <td>${s.departmentName || ''}</td>
                `;
                tableBody.appendChild(tr);
            }
            createForm.reset();
        })
        .catch(err => console.error(err));
    });
</script>
